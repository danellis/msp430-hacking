#include <stdint.h>
#include <legacymsp430.h>
#include <in430.h>
#include <msp430.h>

/*
 * P1.0 = Red LED
 * P1.1 = Cross LED
 * P1.2 = Square LED
 * P1.3 = Octogon LED
 * P1.4 = Triangle LED
 * P1.5 = Circle LED
 * CB0 = Cross pad
 * CB1 = Square pad
 * CB2 = Octogon pad
 * CB3 = Triangle pad
 * CB4 = Circle pad
 * P1.7 = Switch 1 -- untested
 * P2.2 = Switch 2 -- untested
 * P3.3 = ACCEL_SIMO
 * P3.4 = ACCEL_SOMI
 * P3.5 = ACCEL_CS
 * P3.6 = ACCEL_PWR
 * P3.7 = SD_CS
 * P4.0 = PM_UCB1STE/PM_UCA1CLK
 * P4.1/PM_UCB1SIMO/PM_UCB1SDA = SIMO
 * P4.2/PM_UCB1SOMI/PM_UCB1SCL = SOMI
 * P4.3/PM_UCB1CLK/PM_UCA1STE = SCLK
 * P4.4/PM_UCA1TXD/PM_UCA1SIMO = TXD
 * P4.5/PM_UCA1RXD/PM_UCA1SOMI = RXD
 * P5.6/TB0.0 = LCD_D/C (L=command, H=data)
 * P5.7/TB0.1 = ~LCD_RST
 * P6.5/CB5/A5 = Potentiometer wiper
 * P7.4/TB0.1 = ~LCD_CS
 * P7.6/TB0.4 = LCD_BL_EN
 * P8.0 = Potentiometer voltage
 * P8.1 = Yellow LED -- doesn't seem to work
 * P8.2 = Green LED
 */

#define LED_RED(on) (P1OUT = on ? P1OUT | 1 : P1OUT & ~1)
#define LED_GREEN(on) (P8OUT = on ? P8OUT | BIT2 : P8OUT & ~BIT2)

void spi_write_char(unsigned char c) {
    while (UCB1IFG & UCTXIFG == 0);
    UCB1TXBUF = c;
    __delay_cycles(10000);
}

void spi_write(const unsigned char *data, int length) {
    for (int c = 0; c < length; ++c) {
        spi_write_char(data[c]);
    }
}

void cycle_blue_leds(void) {
    for (;;) {
        for (uint8_t led = 1; led <= 5; ++led) {
            P1OUT = (1 << led) | (P1OUT & 1);
            __delay_cycles(100000);
        }
        for (uint8_t led = 4; led >= 2; --led) {
            P1OUT = (1 << led) | (P1OUT & 1);
            __delay_cycles(100000);
        }
    }
}

void main(void) {
    WDTCTL = WDTPW + WDTHOLD;
    
    __eint();

    // Set up outputs
    P1DIR = 0x3f;
    P1OUT = 0;
    P4SEL = BIT1 | BIT2 | BIT3;
    P5SEL = 0;
    P5DIR = BIT6 | BIT7;
    P5OUT = BIT7;
    P7SEL = 0;
    P7DIR = BIT4 | BIT6;
    P7OUT = BIT6;
    P8DIR = BIT2;
    P8OUT = 0;
    
    // Set up USCI B1
    UCB1CTL1 = UCSSEL__SMCLK | UCSWRST;
    UCB1CTL0 = UCMSB | UCMST | UCMODE0 | UCCKPH | UCSYNC;
    UCB1BR0 = 0;
    UCB1BR1 = 1;
    UCB1IE = 3;
    UCB1CTL1 &= ~UCSWRST;
    
    unsigned char lcd_face[] = {
        0x0, 0x0, 0x0, 0x0, 0x0, 0x0, 0x0, 0x0, 0x0, 0x0, 0x0, 0x0, 0x0, 0x0, 0x0, 0x0, 0x0, 0x0, 0x0, 0x0, 0x80, 0xc0, 0x40, 0x60, 0x20, 0x20, 0x30, 0x10, 0x18, 0x8, 0x8, 0x8c, 0xc4, 0x64, 0x24, 0x32, 0x32, 0x32, 0x30, 0x22, 0x62, 0x41, 0x1, 0x1, 0x1, 0x1, 0x1, 0x1, 0x1, 0x1, 0x21, 0x31, 0x31, 0x11, 0x11, 0x11, 0x11, 0x11, 0x11, 0x11, 0x21, 0x60, 0x62, 0x42, 0x2, 0x2, 0x6, 0x4, 0x4, 0xc, 0x8, 0x8, 0x18, 0x10, 0x10, 0x30, 0x20, 0x60, 0x40, 0xc0, 0x80, 0x80, 0x0, 0x0, 0x0, 0x0, 0x0, 0x0, 0x0, 0x0, 0x0, 0x0, 0x0, 0x0, 0x0, 0x0, 0x0, 0x0, 0x0, 0x0, 0x0, 0x0, 0x0, 0x0, 0x0, 0x0, 0x0, 0x0, 0x0, 0x0, 0x0, 0x0, 0x80, 0xc0, 0x60, 0x30, 0x18, 0xc, 0x6, 0x2, 0x3, 0x1, 0x0, 0x0, 0x0, 0x0, 0x0, 0x0, 0x0, 0x0, 0x0, 0x0, 0x20, 0x31, 0x19, 0x68, 0x28, 0x34, 0x34, 0x14, 0x14, 0x9c, 0x98, 0x98, 0xb0, 0x80, 0xc0, 0xc0, 0xc0, 0xc0, 0xc0, 0x80, 0x90, 0x98, 0x98, 0x98, 0x18, 0x8, 0x38, 0x28, 0x38, 0x10, 0x30, 0x30, 0x0, 0x0, 0x0, 0x0, 0x0, 0x0, 0x0, 0x0, 0x0, 0x0, 0x0, 0x0, 0x0, 0x0, 0x0, 0x0, 0x0, 0x0, 0x0, 0x1, 0x1, 0x3, 0x6, 0x6, 0xc, 0x18, 0x30, 0x60, 0xc0, 0x80, 0x0, 0x0, 0x0, 0x0, 0x0, 0x0, 0x0, 0x0, 0x0, 0x0, 0x0, 0x0, 0x0, 0x0, 0x0, 0x0, 0xf0, 0xf8, 0x1e, 0x7, 0x1, 0x0, 0x0, 0x0, 0x0, 0x0, 0x0, 0x0, 0x0, 0x80, 0x80, 0x80, 0x80, 0x80, 0x80, 0x80, 0x80, 0x80, 0x80, 0x0, 0x0, 0x0, 0x0, 0x70, 0xfc, 0x86, 0x2, 0x1, 0x1, 0x1, 0x0, 0x0, 0x0, 0x0, 0x0, 0x0, 0x0, 0x0, 0x0, 0x0, 0x0, 0x0, 0x0, 0x1, 0x1, 0x1, 0x3, 0x86, 0xfe, 0x7c, 0x0, 0x0, 0x0, 0x0, 0x0, 0x10, 0x18, 0x8, 0x8, 0x8, 0x8, 0xc, 0xc, 0xcc, 0x68, 0x8, 0x8, 0x8, 0x18, 0x30, 0x20, 0x60, 0xc0, 0x0, 0x0, 0x0, 0x0, 0x0, 0x0, 0x0, 0x1, 0x3, 0xe, 0x3c, 0xf0, 0xc0, 0x0, 0x0, 0x0, 0x0, 0x0, 0x0, 0x0, 0x0, 0x0, 0x0, 0x0, 0xff, 0xff, 0x0, 0x0, 0x0, 0x0, 0x0, 0x0, 0x0, 0x78, 0xde, 0x86, 0x1, 0x1, 0x4, 0xc, 0x18, 0x0, 0x10, 0x20, 0x20, 0x60, 0xc1, 0xc0, 0xc0, 0x80, 0x80, 0x80, 0x80, 0x80, 0x81, 0x1, 0x2, 0x2, 0x6, 0x6, 0x4, 0x4, 0x4, 0x4, 0xc, 0xc, 0x4, 0x4, 0x4, 0x4, 0x4, 0x6, 0x6, 0x82, 0x82, 0x81, 0x81, 0xc0, 0xc0, 0x40, 0x40, 0x20, 0x20, 0x20, 0xf0, 0xd0, 0x8, 0x8, 0x84, 0xfe, 0x6, 0x1, 0x0, 0x0, 0x0, 0x0, 0x0, 0x0, 0x0, 0x0, 0x0, 0x1, 0x7, 0x0, 0x0, 0x0, 0x0, 0x0, 0x0, 0x0, 0x0, 0x0, 0x0, 0x3, 0xff, 0x38, 0x0, 0x0, 0x0, 0x0, 0x0, 0x0, 0x0, 0x0, 0x0, 0x0, 0x3, 0xf, 0x78, 0xe0, 0x80, 0x0, 0x0, 0x0, 0x0, 0x0, 0x0, 0x1, 0x1, 0x0, 0x0, 0x0, 0x0, 0x0, 0x0, 0x0, 0x0, 0x0, 0x0, 0x3, 0xe, 0x1c, 0x38, 0xf0, 0xf1, 0xef, 0xfd, 0xf1, 0xe1, 0xc1, 0xc1, 0xc1, 0xc7, 0x7f, 0xe1, 0xc1, 0xc1, 0xc1, 0xc1, 0xc1, 0xc1, 0xcf, 0xf9, 0xf1, 0xe1, 0xc1, 0xc0, 0xe0, 0xe0, 0xe3, 0xee, 0xf8, 0x70, 0x30, 0x30, 0x38, 0x38, 0x3d, 0xfe, 0x7f, 0x7, 0x0, 0x0, 0x0, 0x0, 0x0, 0x0, 0x0, 0x0, 0x0, 0x0, 0x0, 0x0, 0x0, 0x0, 0x0, 0x0, 0x0, 0x0, 0x0, 0x0, 0x0, 0x80, 0xe0, 0x78, 0x1e, 0x7, 0x0, 0x0, 0x0, 0x0, 0x0, 0x0, 0x0, 0x0, 0x0, 0x0, 0x0, 0x0, 0x0, 0x0, 0x0, 0x1, 0x7, 0x6, 0x1c, 0x30, 0x70, 0x60, 0xc0, 0x80, 0x0, 0x0, 0x0, 0x0, 0x0, 0x0, 0x0, 0x0, 0x0, 0x0, 0x0, 0x0, 0x0, 0x0, 0x0, 0x0, 0x1, 0x3, 0x7, 0x7, 0xf, 0xf, 0x1f, 0x1f, 0x37, 0x1f, 0x3f, 0x37, 0x3f, 0x27, 0x63, 0x61, 0x60, 0x60, 0x60, 0x60, 0x20, 0x20, 0x2e, 0x27, 0x31, 0x30, 0x10, 0x18, 0x18, 0xc, 0x6, 0x2, 0x3, 0x1, 0x0, 0x0, 0x0, 0x0, 0x0, 0x0, 0x0, 0x0, 0x0, 0x0, 0x0, 0x0, 0x0, 0x0, 0x0, 0x80, 0xc0, 0xc0, 0x60, 0x10, 0x18, 0xc, 0x6, 0x3, 0x1, 0x0, 0x0, 0x0, 0x0, 0x0, 0x0, 0x0, 0x0, 0x0, 0x0, 0x0, 0x0, 0x0, 0x0, 0x0, 0x0, 0x0, 0x0, 0x0, 0x0, 0x0, 0x0, 0x0, 0x0, 0x0, 0x0, 0x1, 0x1, 0x3, 0x2, 0x6, 0xc, 0xc, 0x18, 0x18, 0x10, 0x10, 0x30, 0x20, 0x60, 0x40, 0x40, 0x40, 0xc0, 0x80, 0x80, 0x80, 0x80, 0x0, 0x0, 0x0, 0x0, 0x0, 0x0, 0x0, 0x0, 0x0, 0x0, 0x0, 0x0, 0x0, 0x0, 0x0, 0x0, 0x0, 0x0, 0x80, 0x0, 0x0, 0x0, 0x0, 0x0, 0x80, 0x80, 0x80, 0x80, 0xc0, 0x40, 0x40, 0x60, 0x20, 0x20, 0x30, 0x10, 0x18, 0x8, 0x8, 0xc, 0x4, 0x6, 0x2, 0x3, 0x1, 0x1, 0x0, 0x0, 0x0, 0x0, 0x0, 0x0, 0x0, 0x0, 0x0, 0x0, 0x0, 0x0, 0x0, 0x0, 0x0, 0x0, 0x0, 0x0, 0x80, 0x88, 0xfc, 0x8a, 0x8a, 0x0, 0x88, 0x88, 0xfa, 0x80, 0x80, 0x0, 0x88, 0xf8, 0x88, 0x8, 0xf0, 0x80, 0x50, 0xa8, 0xa8, 0xf0, 0x80, 0x0, 0x82, 0x82, 0xfe, 0x80, 0x80, 0x0, 0x82, 0x82, 0xfe, 0x80, 0x80, 0x0, 0x9, 0x39, 0xc1, 0x39, 0x9, 0x1, 0x1, 0x1, 0x1, 0x1, 0x1, 0x1, 0x89, 0x89, 0xfb, 0x81, 0x81, 0x1, 0x9, 0x7f, 0x89, 0x89, 0x41, 0x1, 0x1, 0x1, 0x0, 0x0, 0x0, 0x0, 0x38, 0xc8, 0x38, 0xc8, 0x38, 0x8, 0x70, 0x88, 0x88, 0x88, 0x70, 0x0, 0x88, 0xf8, 0x90, 0x8, 0x8, 0x0, 0x82, 0xfe, 0x20, 0xd8, 0x88, 0x0, 0x90, 0xa8, 0xa8, 0xa8, 0x48, 0x0, 0x0, 0x0, 0xbe, 0x0, 0x0
    };
    
    unsigned char lcd_init[] = {
        0x40, 0xa1, 0xc0, 0xa4, 0xa6, 0xa2, 0x2f, 0x27, 0x81, 0x10, 0xfa, 0x90, 0xaf
    };
    
    unsigned char lcd_home[] = {
        0x00, 0x10, 0xb0
    };

    unsigned char lcd_data[] = {
        0x01, 0x02, 0x04, 0x08, 0x10, 0x20, 0x40, 0x80
        // 0x80, 0x40, 0x20, 0x10, 0x08, 0x04, 0x02, 0x01
    };
    
    unsigned char lcd_clear_line[] = {0, 0, 0, 0, 0, 0, 0, 0};

    spi_write(lcd_init, sizeof(lcd_init));

    char *c = lcd_face;
    for (int row = 0; row < 8; ++row) {
        P5OUT &= ~BIT6;
        spi_write_char(0x00);
        spi_write_char(0x10);
        spi_write_char(0xb0 | row);
        P5OUT |= BIT6;
        for (int col = 0; col < 102; ++col) {
            spi_write_char(*(c++));
        }
    }
    cycle_blue_leds();
}
